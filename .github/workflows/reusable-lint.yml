name: Reusable Lint

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '20'
      pnpm-version:
        description: 'pnpm version to use'
        required: false
        type: string
        default: '9'
      working-directory:
        description: 'Working directory for commands'
        required: false
        type: string
        default: '.'
      eslint-max-warnings:
        description: 'Maximum number of ESLint warnings allowed'
        required: false
        type: number
        default: 0
      run-prettier-check:
        description: 'Whether to run Prettier format check'
        required: false
        type: boolean
        default: false
      fail-fast:
        description: 'Stop execution on first error'
        required: false
        type: boolean
        default: true

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: ğŸ“¦ Enable Corepack
        run: |
          echo "ğŸ“¦ Enabling Corepack for pnpm management..."
          corepack enable

      - name: ğŸ“¦ Install pnpm ${{ inputs.pnpm-version }}
        run: |
          echo "ğŸ“¦ Installing pnpm version ${{ inputs.pnpm-version }}..."
          corepack prepare pnpm@${{ inputs.pnpm-version }} --activate
          echo "âœ… pnpm version: $(pnpm --version)"

      - name: ğŸ“‚ Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "ğŸ“‚ Getting pnpm store directory..."
          STORE_PATH=$(pnpm store path --silent)
          echo "STORE_PATH=$STORE_PATH" >> $GITHUB_ENV
          echo "âœ… pnpm store path: $STORE_PATH"

      - name: ğŸ—„ï¸ Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ğŸ“¥ Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "ğŸ“¥ Installing dependencies with frozen lockfile..."
          pnpm install --frozen-lockfile
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ” Run ESLint
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "ğŸ” Running ESLint with max warnings: ${{ inputs.eslint-max-warnings }}"
          echo "ğŸ“ Working directory: ${{ inputs.working-directory }}"

          if ! pnpm lint --max-warnings ${{ inputs.eslint-max-warnings }}; then
            echo "âŒ ESLint failed with errors or too many warnings"
            exit 1
          fi

          echo "âœ… ESLint passed successfully"
        continue-on-error: ${{ !inputs.fail-fast }}

      - name: ğŸ¨ Run Prettier check
        if: inputs.run-prettier-check
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "ğŸ¨ Running Prettier format check..."

          if ! pnpm format:check 2>/dev/null && ! prettier --check . 2>/dev/null; then
            echo "âš ï¸ Prettier check not available or failed"
            echo "ğŸ’¡ Ensure 'format:check' script exists or Prettier is installed"
            exit 1
          fi

          echo "âœ… Prettier check passed"
        continue-on-error: ${{ !inputs.fail-fast }}

      - name: ğŸ“Š Lint Summary
        if: always()
        run: |
          echo "ğŸ“Š Lint Job Summary"
          echo "==================="
          echo "Node.js version: ${{ inputs.node-version }}"
          echo "pnpm version: ${{ inputs.pnpm-version }}"
          echo "Working directory: ${{ inputs.working-directory }}"
          echo "Max warnings: ${{ inputs.eslint-max-warnings }}"
          echo "Prettier check: ${{ inputs.run-prettier-check }}"
          echo "Fail fast: ${{ inputs.fail-fast }}"

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… All linting checks passed!"
          else
            echo "âŒ Some linting checks failed"
            exit 1
          fi
